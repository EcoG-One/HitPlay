<!doctype html>
<html lang="en" class="h-full">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HitPlay</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&amp;display=swap" rel="stylesheet">
  <style>
    body {
      box-sizing: border-box;
    }

    * {
      font-family: 'Nunito', sans-serif;
    }

    .card-container {
      perspective: 1000px;
    }

    .card-inner {
      position: relative;
      width: 100%;
      height: 100%;
      transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
      transform-style: preserve-3d;
    }

    .card-inner.flipped {
      transform: rotateY(180deg);
    }

    .card-face {
      position: absolute;
      width: 100%;
      height: 100%;
      backface-visibility: hidden;
      border-radius: 1.5rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 2rem;
    }

    .card-back {
      transform: rotateY(180deg);
    }

    .progress-dot {
      transition: all 0.3s ease;
    }

    .progress-dot.active {
      transform: scale(1.3);
    }

    .progress-dot.completed {
      animation: pulse 0.5s ease;
    }

    @keyframes pulse {

      0%,
      100% {
        transform: scale(1);
      }

      50% {
        transform: scale(1.4);
      }
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(30px);
      }

      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .slide-in {
      animation: slideIn 0.4s ease forwards;
    }

    @keyframes confetti {
      0% {
        transform: translateY(0) rotate(0deg);
        opacity: 1;
      }

      100% {
        transform: translateY(-100px) rotate(720deg);
        opacity: 0;
      }
    }

    .confetti-piece {
      position: absolute;
      animation: confetti 1s ease forwards;
    }
  </style>
  <style>
    @view-transition {
      navigation: auto;
    }
  </style>
</head>

<body id="body" class="h-full m-0 overflow-auto">
  <div id="app" class="min-h-full w-full flex flex-col items-center justify-center p-6"
    style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 50%, #fbbf24 100%);"><!-- Header -->
    <div class="text-center mb-6 slide-in">
      <h1 id="deck-title" class="text-3xl md:text-4xl font-extrabold mb-2" style="color: #92400e;">HitPlay
      <span id="deck-subtitle" class="text-xl md:text-xl font-extrabold mb-1" style="color: #92400e;">by EcoG</span></h1>
      <div class="mt-4 flex flex-wrap gap-2 justify-center">
        <button onclick="setMode('practice')" id="practice-mode-btn"
          class="px-4 py-2 rounded-full font-bold text-sm transition-all duration-200 hover:scale-105 active:scale-95 shadow-md"
          style="background-color: #92400e; color: #ffffff;">Practice</button>
        <button onclick="setMode('game')" id="game-mode-btn"
          class="px-4 py-2 rounded-full font-bold text-sm transition-all duration-200 hover:scale-105 active:scale-95 shadow-md"
          style="background-color: #ffffff; color: #92400e;">Game</button>
        <button onclick="toggleTimer()" id="timer-btn"
          class="px-4 py-2 rounded-full font-bold text-sm transition-all duration-200 hover:scale-105 active:scale-95 shadow-md"
          style="background-color: #ffffff; color: #92400e;"> ‚è±Ô∏è Time Challenge </button>
      </div>
      <!-- Game Controls -->
      <div class="w-full max-w-md mt-4 flex flex-wrap gap-2 justify-center">
        <button onclick="toggleShuffle()" id="shuffle-btn"
          class="px-4 py-2 rounded-full font-bold text-sm transition-all duration-200 hover:scale-105 active:scale-95 shadow-md"
          style="background-color: #ffffff; color: #92400e;"> üîÄ Shuffle </button>
        <button onclick="pauseAudio()" id="pause-btn"
          class="px-4 py-2 rounded-full font-bold text-sm transition-all duration-200 hover:scale-105 active:scale-95 shadow-md"
          style="background-color: #ffffff; color: #92400e;"> üîá Pause </button>
        <button onclick="skipAhead()" id="skip-btn"
          class="px-4 py-2 rounded-full font-bold text-sm transition-all duration-200 hover:scale-105 active:scale-95 shadow-md"
          style="background-color: #ffffff; color: #92400e;"> ‚è© +10s </button>
        <button onclick="changeFolder()" id="change-folder-btn"
          class="px-4 py-2 rounded-full font-bold text-sm transition-all duration-200 hover:scale-105 active:scale-95 shadow-md"
          style="background-color: #ffffff; color: #92400e;"> üìÅ Change Folder </button>
      </div>
    </div>
    <div id="game-layout" class="w-full max-w-6xl flex flex-col md:flex-row items-start gap-6">
      <div id="player-panel" class="hidden w-full md:w-56 rounded-2xl shadow-lg p-4 mt-4" style="background-color: #ffffff;">
        <div class="text-lg font-extrabold mb-3" style="color: #92400e;">Players</div>
        <div id="player-list" class="flex flex-col gap-2"></div>
        <!-- Player Navigation Buttons -->
        <div class="flex gap-2"><button onclick="prevPlayer()" id="prev-player-btn"
            class="px-3 py-1 rounded-full font-bold text-lg transition-all duration-200 hover:scale-105 active:scale-95 disabled:opacity-40 disabled:cursor-not-allowed shadow-lg"
            style="background-color: #ffffff; color: #92400e;"> ‚Üê Back </button> <button onclick="nextPlayer()" id="next-player-btn"
            class="px-3 py-1 rounded-full font-bold text-lg transition-all duration-200 hover:scale-105 active:scale-95 shadow-lg"
            style="background-color: #92400e; color: #ffffff;"> Next ‚Üí </button>
        </div>
      </div>
      <!-- Main Game Area -->
      <div id="game-main"
     class="flex-1 w-full flex flex-col items-center">
       
    <!-- Score and Timer Display -->
    <div class="flex items-center gap-6 mb-4">
      <div id="score-display-container" class="text-center px-4 py-2 rounded-full shadow-md" style="background-color: #ffffff;"><span
          class="text-sm font-bold" style="color: #92400e;">Score: <span id="score-display">0</span></span>
      </div>
      <div id="timer-display" class="hidden text-center px-4 py-2 rounded-full shadow-md"
        style="background-color: #ffffff;"><span class="text-sm font-bold" style="color: #92400e;">‚è±Ô∏è <span
            id="timer-text">60</span>s</span>
      </div>
    </div>
    
    <!-- Progress Indicator -->
    <div id="progress-ind" class="flex items-center gap-3 mb-6">
      <div id="progress-dots" class="flex gap-2"><!-- Dots generated by JS -->
      </div><span id="progress-text" class="text-sm font-bold ml-2" style="color: #92400e;">0 / 0</span>
    </div>
    
    <!-- Flashcard -->
    <div class="card-container w-full max-w-md h-64 md:h-72 mb-6 cursor-pointer" id="card" onclick="flipCard()">
      <div class="card-inner" id="card-inner">
        <!-- Front -->
        <div class="card-face shadow-2xl" style="background: linear-gradient(145deg, #ffffff 0%, #f3f4f6 100%);"><span
            class="text-5xl mb-4" id="card-emoji">üëã</span> <span class="text-3xl md:text-4xl font-bold text-center"
            id="card-term" style="color: #1f2937;">Hola</span> <span class="text-sm mt-4 font-semibold"
            style="color: #9ca3af;">Click to reveal</span>
        </div>
        <!-- Back -->
        <div class="card-face card-back shadow-2xl" style="background: linear-gradient(145deg, #fbbf24 0%, #f59e0b 100%);">
          <span class="text-5xl mb-4">‚ú®</span> <span class="text-3xl md:text-4xl font-bold text-center" id="card-definition"
            style="color: #ffffff;">Shuffle Cards to Start</span> <span class="text-sm mt-4 font-semibold" 
            style="color: #fef3c7;">Click to flip back</span>
        </div>
      </div>
      <div class="hidden" id="card-wait"><!-- Please Wait -->
        <div class="text-center px-4 py-2 rounded-full shadow-md"
          class="w-full h-full flex flex-col items-center justify-center bg-white bg-opacity-80 rounded-2xl shadow-2xl">
          <img src="wait.png" alt="Creating Cards">
          <span class="text-4xl mb-4">‚è≥</span>
          <span class="text-xl font-bold" style="color: #1f2937;">Creating Cards. Please Wait...</span>
        </div>
      </div>

    </div><!-- Response Buttons -->
    <div id="response-buttons" class="hidden flex gap-4 mb-4"><button onclick="markCard(false)"
        class="px-6 py-3 rounded-full font-bold text-lg transition-all duration-200 hover:scale-105 active:scale-95 shadow-lg"
        style="background-color: #ef4444; color: #ffffff;"> üòï Learning </button> <button onclick="markCard(true)"
        class="px-6 py-3 rounded-full font-bold text-lg transition-all duration-200 hover:scale-105 active:scale-95 shadow-lg"
        style="background-color: #22c55e; color: #ffffff;"> ‚úÖ I Know This! </button>
    </div><!-- Score Buttons -->
    <div id="score-buttons" class="hidden flex gap-4 mb-4">
      <button onclick="addScore(0)"
        class="px-6 py-3 rounded-full font-bold text-lg transition-all duration-200 hover:scale-105 active:scale-95 shadow-lg"
        style="background-color: #ffffff; color: #92400e;">0</button>
      <button onclick="addScore(1)"
        class="px-6 py-3 rounded-full font-bold text-lg transition-all duration-200 hover:scale-105 active:scale-95 shadow-lg"
        style="background-color: #ffffff; color: #92400e;">1</button>
      <button onclick="addScore(2)"
        class="px-6 py-3 rounded-full font-bold text-lg transition-all duration-200 hover:scale-105 active:scale-95 shadow-lg"
        style="background-color: #ffffff; color: #92400e;">2</button>
      <button onclick="addScore(3)"
        class="px-6 py-3 rounded-full font-bold text-lg transition-all duration-200 hover:scale-105 active:scale-95 shadow-lg"
        style="background-color: #ffffff; color: #92400e;">3</button>
      <button onclick="addScore(4)"
        class="px-6 py-3 rounded-full font-bold text-lg transition-all duration-200 hover:scale-105 active:scale-95 shadow-lg"
        style="background-color: #ffffff; color: #92400e;">4</button>
    </div><!-- Navigation Buttons -->
    <div class="flex gap-4 mb-6"><button onclick="prevCard()" id="prev-btn"
        class="px-6 py-3 rounded-full font-bold text-lg transition-all duration-200 hover:scale-105 active:scale-95 disabled:opacity-40 disabled:cursor-not-allowed shadow-lg"
        style="background-color: #ffffff; color: #92400e;"> ‚Üê Back </button> <button onclick="nextCard()" id="next-btn"
        class="px-6 py-3 rounded-full font-bold text-lg transition-all duration-200 hover:scale-105 active:scale-95 shadow-lg"
        style="background-color: #92400e; color: #ffffff;"> Next ‚Üí </button>
    </div><!-- Completion Message -->
    <div id="completion-message" class="hidden text-center p-6 rounded-2xl shadow-xl"
      style="background-color: #ffffff;">
      <div id="confetti-container" class="relative"></div><span class="text-4xl mb-2 block">üéâ</span>
      <h2 class="text-2xl font-extrabold mb-2" style="color: #92400e;">Rock On!</h2>
      <p id="completion-text" class="text-lg mb-2" style="color: #b45309;">You've completed all 10 songs!</p>
      <p class="text-2xl font-bold mb-4" style="color: #92400e;">Final Score: <span id="final-score">0</span> / 10</p>
      <button onclick="restart()"
        class="px-6 py-3 rounded-full font-bold text-lg transition-all duration-200 hover:scale-105 active:scale-95 shadow-lg"
        style="background-color: #fbbf24; color: #92400e;"> Practice Again üîÑ </button>
    </div>
      </div>
    </div>
  </div>
  <script>
    let flashcards = [];

    let currentIndex = 0;
    let isFlipped = false;
    let viewedCards = new Set();
    let score = 0;
    let isShuffled = false;
    let isPlaying = true;
    let timerMode = false;
    let timeRemaining = 60;
    let timerInterval = null;
    let cardOrder = [];
    let currentAudio = null;
    let mode = 'practice';
    let players = [];
    let currentPlayerIndex = 0;

    const defaultConfig = {
      deck_title: "Pop Rock Classics",
      encouragement_text: "You've completed all songs!",
      background_color: "#fbbf24",
      card_color: "#ffffff",
      text_color: "#92400e",
      button_color: "#92400e",
      accent_color: "#f59e0b",
      font_family: "Nunito",
      font_size: 16
    };

    function setMode(nextMode) {
      if (nextMode === 'practice') {
        mode = 'practice';
        players = [];
        currentPlayerIndex = 0;
        document.getElementById('player-panel').classList.add('hidden');
        updateModeButtons();
        restart();
        return;
      }

      if (nextMode === 'game') {
        const names = promptForPlayers();
        if (!names) {
          return;
        }
        mode = 'game';
        players = names.map(name => ({ name, score: 0 }));
        currentPlayerIndex = 0;
        renderPlayerList();
        document.getElementById('player-panel').classList.remove('hidden');
        updateModeButtons();
        restart();
      }
    }

    function updateModeButtons() {
      const practiceBtn = document.getElementById('practice-mode-btn');
      const gameBtn = document.getElementById('game-mode-btn');
      const progress = document.getElementById('progress-ind');
      const gameMain = document.getElementById('game-main');
      const scoreDisplay = document.getElementById('score-display-container');
      if (mode === 'game') {
        gameBtn.style.backgroundColor = '#92400e';
        gameBtn.style.color = '#ffffff';
        practiceBtn.style.backgroundColor = '#ffffff';
        practiceBtn.style.color = '#92400e';
        scoreDisplay.classList.add('hidden');
        progress.classList.add('hidden');
        gameMain.classList.add('max-w-2xl');
      } else {
        scoreDisplay.classList.remove('hidden'); 
        progress.classList.remove('hidden');
        practiceBtn.style.backgroundColor = '#92400e';
        practiceBtn.style.color = '#ffffff';
        gameBtn.style.backgroundColor = '#ffffff';
        gameBtn.style.color = '#92400e';
        gameMain.classList.remove('max-w-2xl');
      }
    }

    function promptForPlayers() {
      while (true) {
        const input = prompt('Enter player names (comma separated):');
        if (input === null) {
          return null;
        }
        const names = input
          .split(',')
          .map(name => name.trim())
          .filter(Boolean);
        if (names.length) {
          return names;
        }
      }
    }

    function renderPlayerList() {
      const list = document.getElementById('player-list');
      list.innerHTML = '';
      players.forEach((player, index) => {
        const item = document.createElement('div');
        item.className = 'flex items-center justify-between px-3 py-2 rounded-xl font-bold';
        if (index === currentPlayerIndex) {
          item.style.backgroundColor = '#fef3c7';
          item.style.color = '#92400e';
        } else {
          item.style.backgroundColor = '#ffffff';
          item.style.color = '#92400e';
          item.style.border = '1px solid #fde68a';
        }
        const nameSpan = document.createElement('span');
        nameSpan.textContent = player.name;
        const scoreSpan = document.createElement('span');
        scoreSpan.textContent = player.score;
        item.appendChild(nameSpan);
        item.appendChild(scoreSpan);
        list.appendChild(item);
      });
    }

    function setActivePlayer(nextIndex) {
      if (!players.length) {
        return;
      }
      currentPlayerIndex = nextIndex;
      renderPlayerList();
    }

    function addScore(points) {
      if (mode !== 'game' || !players.length) {
        return;
      }
      players[currentPlayerIndex].score += points;
      score += points;
      updateScore();
      renderPlayerList();
      nextPlayer()
      viewedCards.add(currentIndex);
      // renderProgressDots();

      setTimeout(() => {
        if (currentIndex < flashcards.length - 1) {
          currentIndex++;
          resetCardFlip();
          updateCard();
        } else {
          showCompletion();
        }
      }, 300);
    }

    async function loadFlashcards() {
      try {
        const response = await fetch('flashcards.json', { cache: 'no-store' });
        if (!response.ok) {
          throw new Error(`Failed to load flashcards: ${response.status}`);
        }
        flashcards = await response.json();
        cardOrder = flashcards.map((_, i) => i);
       // updateCard();
      } catch (error) {
        console.error('Failed to load flashcards.json', error);
        document.getElementById('card-emoji').textContent = '!';
        document.getElementById('card-term').textContent = 'Failed to load flashcards.';
        document.getElementById('card-definition').textContent = 'Check flashcards.json.';
      }
    }

    function renderProgressDots() {
      const container = document.getElementById('progress-dots');
      container.innerHTML = '';
      for (let i = 0; i < 20; i++) {
        const dot = document.createElement('div');
        dot.className = `progress-dot w-3 h-3 rounded-full transition-all duration-300`;
        dot.style.backgroundColor = viewedCards.has(i) ? '#92400e' : '#fde68a';
        dot.style.border = i === currentIndex ? '2px solid #92400e' : 'none';
        if (i === currentIndex) dot.classList.add('active');
        container.appendChild(dot);
      };
    }

    function updateCard() {
      const actualIndex = cardOrder[currentIndex];
      const card = flashcards[actualIndex];
      setTimeout(() => {
        document.getElementById('card-emoji').textContent = card.emoji;
        document.getElementById('card-term').textContent = "Can you find the Artist, Title and Year?";
        document.getElementById('card-definition').textContent = card.definition;
      }, 400);
      document.getElementById('progress-text').textContent = `${currentIndex + 1} / ${flashcards.length}`;

      document.getElementById('prev-btn').disabled = currentIndex === 0;

      const nextBtn = document.getElementById('next-btn');
      if (currentIndex === flashcards.length - 1) {
        nextBtn.textContent = 'Finish üéØ';
      } else {
        nextBtn.textContent = 'Next ‚Üí';
      }

      document.getElementById('response-buttons').classList.add('hidden');
      document.getElementById('score-buttons').classList.add('hidden');

      if (currentAudio) {
        currentAudio.pause();
        currentAudio.currentTime = 0;
      }
      currentAudio = new Audio(card.term);
      currentAudio.play();

      renderProgressDots();
    }

    function stopAudio() {
      if (currentAudio) {
        currentAudio.pause();
        currentAudio.currentTime = 0;
      }
    }

    function pauseAudio() {
      const btn = document.getElementById('pause-btn'); 
      isPlaying = !isPlaying;
      if (currentAudio) {
        if (isPlaying) {
          currentAudio.play();
          btn.style.backgroundColor = '#ffffff';
          btn.style.color = '#92400e';
          btn.textContent = 'üîá Pause ';
        } else {
          currentAudio.pause();
          btn.style.backgroundColor = '#92400e';
          btn.style.color = '#ffffff';
          btn.textContent = 'üîáPaused';
        }
      }
    }

    function skipAhead() {
      if (!currentAudio) {
        return;
      }
      const seek = () => {
        const nextTime = currentAudio.currentTime + 10;
        if (Number.isFinite(currentAudio.duration)) {
          const safeEnd = Math.max(0, currentAudio.duration - 0.01);
          currentAudio.currentTime = Math.min(nextTime, safeEnd);
        } else {
          currentAudio.currentTime = nextTime;
        }
      };

      if (currentAudio.readyState >= 1) {
        seek();
      } else {
        currentAudio.addEventListener('loadedmetadata', seek, { once: true });
        currentAudio.load();
      }
    }

    function minimizeBrowserWindow() {
      try {
        if (window.elementSdk && typeof window.elementSdk.minimize === 'function') {
          window.elementSdk.minimize();
          return () => {
            if (typeof window.elementSdk.restore === 'function') {
              window.elementSdk.restore();
            } else {
              window.focus();
            }
          };
        }
        if (window.electronAPI && typeof window.electronAPI.minimize === 'function') {
          window.electronAPI.minimize();
          return () => {
            if (typeof window.electronAPI.restore === 'function') {
              window.electronAPI.restore();
            } else {
              window.focus();
            }
          };
        }
      } catch (error) {
        console.warn('Unable to minimize window', error);
      }
      window.blur();
      return () => window.focus();
    }

    async function changeFolder() {
      const restoreWindow = minimizeBrowserWindow();
      var cardNormal = document.getElementById('card-inner');
      var cardWait = document.getElementById('card-wait');
      var prevBtn = document.getElementById('prev-btn');
      var nextBtn = document.getElementById('next-btn');
      var responseButtons = document.getElementById('response-buttons');
      var scoreButtons = document.getElementById('score-buttons');
      
      cardNormal.style.display = 'none';
      prevBtn.style.display = 'none';
      nextBtn.style.display = 'none';
      if (responseButtons.style.display == 'block') {
        responseButtons.style.display = 'none'};
      if (scoreButtons.style.display == 'block') {
        scoreButtons.style.display = 'none'};
      cardWait.style.display = 'block';
      stopAudio();
      try {
        const response = await fetch('/change-folder', { cache: 'no-store' });
        if (!response.ok) {
          const message = await response.text();
          throw new Error(message || `Change folder failed (${response.status})`);
        }
       /* currentIndex = 0;
        viewedCards.clear();
        score = 0;
        updateScore();
        resetCardFlip(); */
        await loadFlashcards();
      } catch (error) {
        console.error('Failed to change folder', error);
      } finally {
        cardWait.style.display = 'none';
        cardNormal.style.display = 'block';
        prevBtn.style.display = 'block';
        nextBtn.style.display = 'block';
     //   responseButtons.style.display = 'block';
        restoreWindow();
        if (isShuffled) {
          isShuffled = !isShuffled;}
        toggleShuffle()
      //  restart();
      }
    }

    function toggleShuffle() {
      isShuffled = !isShuffled;
      const btn = document.getElementById('shuffle-btn');

      if (isShuffled) {
        cardOrder = [...Array(flashcards.length).keys()].sort(() => Math.random() - 0.5);
        btn.style.backgroundColor = '#92400e';
        btn.style.color = '#ffffff';
        btn.textContent = 'üîÄ Shuffled!';
      } else {
        cardOrder = flashcards.map((_, i) => i);
        btn.style.backgroundColor = '#ffffff';
        btn.style.color = '#92400e';
        btn.textContent = 'üîÄ Shuffle';
      }

      currentIndex = 0;
      viewedCards.clear();
      score = 0;
      updateScore();
      resetCardFlip();
      updateCard();
    }

    function toggleTimer() {
      timerMode = !timerMode;
      const btn = document.getElementById('timer-btn');
      const display = document.getElementById('timer-display');

      if (timerMode) {
        btn.style.backgroundColor = '#92400e';
        btn.style.color = '#ffffff';
        btn.textContent = '‚è±Ô∏è Timer ON';
        display.classList.remove('hidden');
        startTimer();
      } else {
        btn.style.backgroundColor = '#ffffff';
        btn.style.color = '#92400e';
        btn.textContent = '‚è±Ô∏è Timer Challenge';
        display.classList.add('hidden');
        stopTimer();
      }
    }

    function startTimer() {
      timeRemaining = 60;
      updateTimerDisplay();
      timerInterval = setInterval(() => {
        timeRemaining--;
        updateTimerDisplay();

        if (timeRemaining <= 0) {
          stopTimer();
          showTimeUpMessage();
        }
      }, 1000);
    }

    function stopTimer() {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
    }

    function updateTimerDisplay() {
      const timerText = document.getElementById('timer-text');
      timerText.textContent = timeRemaining;

      if (timeRemaining <= 10) {
        timerText.style.color = '#ef4444';
      } else {
        timerText.style.color = '#92400e';
      }
    }

    function showTimeUpMessage() {
      const card = document.getElementById('card');
      card.style.opacity = '0.5';
      card.style.pointerEvents = 'none';

      const message = document.createElement('div');
      message.className = 'text-center p-6 rounded-2xl shadow-xl mb-6';
      message.style.backgroundColor = '#ffffff';
      message.innerHTML = `
        <span class="text-4xl mb-2 block">‚è∞</span>
        <h3 class="text-2xl font-bold mb-2" style="color: #92400e;">Time's Up!</h3>
        <p class="text-lg mb-4" style="color: #b45309;">You scored ${score} out of ${viewedCards.size} cards attempted!</p>
        <button onclick="restart()" class="px-6 py-3 rounded-full font-bold text-lg transition-all duration-200 hover:scale-105 active:scale-95 shadow-lg" style="background-color: #fbbf24; color: #92400e;">
          Try Again üîÑ
        </button>
      `;

      card.parentNode.insertBefore(message, card);
    }

    function updateScore() {
      document.getElementById('score-display').textContent = score;
    }

    function markCard(correct) {
      if (correct) {
        score++;
        updateScore();
      }

      viewedCards.add(currentIndex);
      renderProgressDots();

      setTimeout(() => {
        if (currentIndex < flashcards.length - 1) {
          currentIndex++;
          resetCardFlip();
          updateCard();
        } else {
          showCompletion();
        }
      }, 300);
    }

    function flipCard() {
      isFlipped = !isFlipped;
      document.getElementById('card-inner').classList.toggle('flipped', isFlipped);
      if (isFlipped) {
        if (mode === 'game') {
          document.getElementById('score-buttons').classList.remove('hidden');
          document.getElementById('response-buttons').classList.add('hidden');
        } else {
          document.getElementById('response-buttons').classList.remove('hidden');
          document.getElementById('score-buttons').classList.add('hidden');
        }
      } else {
        document.getElementById('response-buttons').classList.add('hidden');
        document.getElementById('score-buttons').classList.add('hidden');
      }
    }

    function nextCard() {
      if (currentIndex < flashcards.length - 1) {
        currentIndex++;
        resetCardFlip();
        updateCard();
      } else if (viewedCards.size === flashcards.length) {
        showCompletion();
      }
    }

    function prevCard() {
      if (currentIndex > 0) {
        currentIndex--;
        resetCardFlip();
        updateCard();
      }
    }


    function prevPlayer() {
      if (!players.length) {
        return;
      }
      const prevIndex = (currentPlayerIndex - 1 + players.length) % players.length;
      setActivePlayer(prevIndex);
    }
    function nextPlayer() {
      if (!players.length) {
        return;
      }
      const nextIndex = (currentPlayerIndex + 1) % players.length;
      setActivePlayer(nextIndex);
    }

    function resetCardFlip() {
      isFlipped = false;
      document.getElementById('card-inner').classList.remove('flipped');
    }

    function showCompletion() {
      stopTimer();
      document.getElementById('card').classList.add('hidden');
      document.querySelectorAll('.flex.gap-4').forEach(el => el.classList.add('hidden'));
      document.getElementById('response-buttons').classList.add('hidden');
      document.getElementById('score-buttons').classList.add('hidden');
      document.getElementById('completion-message').classList.remove('hidden');
      document.getElementById('final-score').textContent = score;
      createConfetti();
    }

    function createConfetti() {
      const container = document.getElementById('confetti-container');
      const colors = ['#fbbf24', '#f59e0b', '#92400e', '#fef3c7', '#ffffff'];
      const emojis = ['üéâ', '‚≠ê', 'üåü', '‚ú®', 'üéä'];

      for (let i = 0; i < 12; i++) {
        const piece = document.createElement('span');
        piece.className = 'confetti-piece';
        piece.textContent = emojis[Math.floor(Math.random() * emojis.length)];
        piece.style.left = `${Math.random() * 100}%`;
        piece.style.animationDelay = `${Math.random() * 0.5}s`;
        piece.style.fontSize = `${Math.random() * 16 + 12}px`;
        container.appendChild(piece);
      }
    }

    function restart() {
      currentIndex = 0;
      viewedCards.clear();
      score = 0;
      updateScore();
      resetCardFlip();

      if (timerMode) {
        cardOrder = [...Array(flashcards.length).keys()].sort(() => Math.random() - 0.5);
        startTimer();
      }

      updateCard();

      const timeUpMsg = document.querySelector('.text-center.p-6.rounded-2xl.shadow-xl.mb-6');
      if (timeUpMsg && timeUpMsg !== document.getElementById('completion-message')) {
        timeUpMsg.remove();
      }

      const card = document.getElementById('card');
      card.style.opacity = '1';
      card.style.pointerEvents = 'auto';
      card.classList.remove('hidden');

      document.querySelectorAll('.flex.gap-4').forEach(el => el.classList.remove('hidden'));
      document.getElementById('completion-message').classList.add('hidden');
      document.getElementById('confetti-container').innerHTML = '';
      document.getElementById('response-buttons').classList.add('hidden');
      document.getElementById('score-buttons').classList.add('hidden');
    }

    async function onConfigChange(config) {
      const deckTitle = document.getElementById('deck-title');
      const completionText = document.getElementById('completion-text');

      deckTitle.textContent = config.deck_title || defaultConfig.deck_title;
      completionText.textContent = config.encouragement_text || defaultConfig.encouragement_text;

      const bgColor = config.background_color || defaultConfig.background_color;
      const textColor = config.text_color || defaultConfig.text_color;
      const buttonColor = config.button_color || defaultConfig.button_color;
      const accentColor = config.accent_color || defaultConfig.accent_color;
      const cardColor = config.card_color || defaultConfig.card_color;

      document.getElementById('app').style.background = `linear-gradient(135deg, #fef3c7 0%, #fde68a 50%, ${bgColor} 100%)`;

      deckTitle.style.color = textColor;
      document.querySelector('#app > div > p').style.color = textColor;
      document.getElementById('progress-text').style.color = textColor;

      const prevBtn = document.getElementById('prev-btn');
      prevBtn.style.color = textColor;
      prevBtn.style.backgroundColor = cardColor;

      const nextBtn = document.getElementById('next-btn');
      nextBtn.style.backgroundColor = buttonColor;
      nextBtn.style.color = cardColor;

      const cardFront = document.querySelector('.card-face:not(.card-back)');
      cardFront.style.background = `linear-gradient(145deg, ${cardColor} 0%, #f3f4f6 100%)`;
      document.getElementById('card-term').style.color = textColor;

      const cardBack = document.querySelector('.card-back');
      cardBack.style.background = `linear-gradient(145deg, ${bgColor} 0%, ${accentColor} 100%)`;

      const completionBox = document.getElementById('completion-message');
      completionBox.style.backgroundColor = cardColor;
      completionBox.querySelector('h2').style.color = textColor;
      completionBox.querySelector('p').style.color = accentColor;
      const restartBtn = completionBox.querySelector('button');
      restartBtn.style.backgroundColor = bgColor;
      restartBtn.style.color = textColor;

      const customFont = config.font_family || defaultConfig.font_family;
      const baseFontStack = 'Nunito, sans-serif';
      const fontStack = `${customFont}, ${baseFontStack}`;

      document.querySelectorAll('h1, h2, p, span, button').forEach(el => {
        el.style.fontFamily = fontStack;
      });

      const baseSize = config.font_size || defaultConfig.font_size;
      deckTitle.style.fontSize = `${baseSize * 2}px`;
      document.getElementById('card-term').style.fontSize = `${baseSize * 2}px`;
      document.getElementById('card-definition').style.fontSize = `${baseSize * 2}px`;
      document.querySelectorAll('button').forEach(btn => {
        btn.style.fontSize = `${baseSize * 1.125}px`;
      });

      renderProgressDots();
    }

    function mapToCapabilities(config) {
      return {
        recolorables: [
          {
            get: () => config.background_color || defaultConfig.background_color,
            set: (value) => { config.background_color = value; window.elementSdk.setConfig({ background_color: value }); }
          },
          {
            get: () => config.card_color || defaultConfig.card_color,
            set: (value) => { config.card_color = value; window.elementSdk.setConfig({ card_color: value }); }
          },
          {
            get: () => config.text_color || defaultConfig.text_color,
            set: (value) => { config.text_color = value; window.elementSdk.setConfig({ text_color: value }); }
          },
          {
            get: () => config.button_color || defaultConfig.button_color,
            set: (value) => { config.button_color = value; window.elementSdk.setConfig({ button_color: value }); }
          },
          {
            get: () => config.accent_color || defaultConfig.accent_color,
            set: (value) => { config.accent_color = value; window.elementSdk.setConfig({ accent_color: value }); }
          }
        ],
        borderables: [],
        fontEditable: {
          get: () => config.font_family || defaultConfig.font_family,
          set: (value) => { config.font_family = value; window.elementSdk.setConfig({ font_family: value }); }
        },
        fontSizeable: {
          get: () => config.font_size || defaultConfig.font_size,
          set: (value) => { config.font_size = value; window.elementSdk.setConfig({ font_size: value }); }
        }
      };
    }

    function mapToEditPanelValues(config) {
      return new Map([
        ["deck_title", config.deck_title || defaultConfig.deck_title],
        ["encouragement_text", config.encouragement_text || defaultConfig.encouragement_text]
      ]);
    }

    // Initialize
    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange,
        mapToCapabilities,
        mapToEditPanelValues
      });
    }
    updateModeButtons();
    loadFlashcards();
  </script>
</body>

</html>
